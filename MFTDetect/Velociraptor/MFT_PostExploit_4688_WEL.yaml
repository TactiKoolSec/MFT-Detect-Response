name: test
description: |
   Collection Process Creation Events where the parent process is the MFT web application process. This is a sample artifact and should be customized and updated before being used in production

# Can be CLIENT, CLIENT_EVENT, SERVER, SERVER_EVENT

type: CLIENT
parameters:
  - name: Inclusion
    default: >-
     powershell|rundll32|wmic|regsvr32|mshta|wscript|cscript|conhost|certutil|cmd|msbuild|csc|mavinject|regsvcs|regsvr
sources:
  - precondition:
      SELECT OS From info() where OS = 'windows'

    description: |
      schema:
        - ComputerName: str
        - System: json
        - EventData: json
        - Message: str
    queries: 
        - |
            LET compname <= SELECT Hostname FROM info()
        - |  
            LET Updaterow = SELECT get(item=compname, member="0.Hostname") as ComputerName,System,EventData,Message FROM scope()
        - |
            SELECT * FROM foreach(
            row={SELECT System,EventData,Message FROM parse_evtx(filename="C:/Windows/System32/Winevt/Logs/Security.evtx") WHERE System.EventID.Value = 4688 AND lowcase(string=EventData.ParentProcessName) =~ '[WebAppProcess]' AND lowcase(string=EventData.NewProcessName) =~ Inclusion},
                query=Updaterow)